# ExcelSapTools
Excel SAP連携ツール

## 概要
1. ExcelBatchInputTool.xlsm
   - トランザクションレコーダ(SHDB)で作成したバッチインプット定義を使用してExcelからバッチインプットを実行します。
   - 64Bit版Excel＋64Bit版RFCコントロール対応版

2. ExcelSapQueryTool.xlsm
   - クエリ定義を読み込んでExcel上で検索条件を指定してクエリを実行します。
   - 64Bit版Excel＋64Bit版RFCコントロール対応版

3. 旧版（RFCコントロールが32Bit版しか存在しない頃に、64Bit版Excelから使用するためにVBScriptを経由して32Bit版RFCコントロールを呼び出す作りにしたもの。）
   - RunAsVBS32bit\ExcelBIsheet.xlsm （Excelバッチインプットツール旧版）
   - RunAsVBS32bit\ExcelSapQuery.xlsm （Excelクエリツール旧版）

## 前提
- SAP GUI（RFCコントロール）がインストール済であること。
- 使用するExcelとRFCコントロールで32Bit版/64Bit版の種類が同一であること。

## 使用方法
### ExcelBIsheet.xlsm （Excelバッチインプットツール）
1. 事前準備
   - SAPのトランザクションレコーダ（Tr-CD：SHDB）でバッチインプット対象のトランザクションを記録してください。
   - （必要に応じて）記録した内容を変更で開き、記録内容の不要な行を削除するなど編集してください。
   - 記録が正常に動作することを確認した後、記録を照会で開いて「エクスポート」ボタンを押下してファイルを出力してください。
2. 定義ファイル読込
   - Dataシートの「定義ファイル読込」ボタンを押下し、事前準備で出力したファイルを読み込んでください。
   - セルB5にトランザクションコード、8～13行目にバッチインプット処理内容が出力されます。
3. バッチインプット内容編集
   - Dataシートのセルの14行目以降がバッチインプット対象データの入力箇所になります。
   - 13行目（定義ファイルでの設定値が入っています）を参考にセルを編集してください。
   - A列に"X"を入力すると、その行の値が処理対象となります。
   - C列以降のバッチインプット項目に読み飛ばし文字（セルB5の値で初期値は"#"）を入力するとその列の値はバッチインプットデータとして出力しません。例えばマスタ変更で「ブランクに上書き」するのではなく、既存の値を変更しないという場合には読み飛ばし文字を指定してください。
   - 読み飛ばし文字はPROGRAM/DYNPRO/OKCODEの列に対しても指定可能です。バッチインプットの画面遷移を理解した上で適切に使用すれば、行毎の内容に応じて画面遷移が変わる場合にも1つの定義ファイルを使用することが可能です。
4. バッチインプット実行
   - Dataシートの「バッチインプット実行」ボタンを押下してください。
   - A列に"X"が入力された行についてバッチインプットが行われ、処理結果が右端のセルに出力されます。
   - 処理後はA列の"X"は"-"に変わります。
   - 対象全件の処理が完了するとメッセージが表示されます。

### ExcelSapQuery.xlsm （Excelクエリツール）
1. クエリ情報取得
   - DataシートのセルB1～B4にクエリ領域・クエリ名・ユーザグループを入力して「クエリ情報取得」ボタンを押下してください。
   - セルI11以降にクエリの検索条件項目の情報が出力されます。
2. 検索条件入力
   - セルA12以降に検索条件を入力してください。
   - A列はドロップダウンリストになっており、I列以降の検索条件項目名が選択可能になっています。値を選択するとB列（SELNAME）とC列（KIND）が入ります。
   - C列（KIND）が”P"の場合は単一指定のパラメータ項目です。F列（LOW）に条件の値を入力してください。
   - C列（KIND）が”S"の場合は選択オプションです。SIGN/OPTION/LOW/HIGHを適宜入力してください。複数条件を指定する場合はそれぞれ行を分けて入力してください。
   - 複数条件を入力する際に行が不足する場合は、検索条件の最終行をコピー＋行挿入して行を追加してください。
3. クエリ実行
   - 「クエリ実行」ボタンを押下すると、実行結果が出力されます。

### 旧版ツール
- ファイル内の説明・サンプルデータをご参照ください。

## 補足
以前に個人的に作って使っていたツールをGUIの64Bit版対応に合わせて作り替えたものです。GUIのバージョンとRFCコントロールの関係は以下のとおりです。

- GUI760まで
  - SAPGUIは32Bit版しか存在していませんでした。そのため、64Bit版Excelからは32Bit版RFCコントロールを直接呼び出すことができず、32Bit版Excelを使用するか、旧版ツールのように32Bit版VBScriptから32Bit版RFCコントロールを呼び出すようなやり方が必要でした。
- GUI770
  - SAPGUIは32Bit版のみですが、新たに64Bit版RFCコントロールが提供されるようになりました。64Bit版RFCコントロールを追加インストールすることで、64Bit版Excelから直接64Bit版RFCコントロールを呼び出すことが可能になりました。
- GUI800
  - SAPGUI自体が32Bit版に加えて64Bit版が提供されるようになりました。64Bit版GUIをインストールすれば64Bit版RFCコントロールも付属しているため、追加インストールの手間が不要で全て64Bit版で揃えられるようになりました。
